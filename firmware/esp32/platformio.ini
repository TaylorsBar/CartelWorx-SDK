; PlatformIO Configuration for CartelWorx SDK - ESP32 FreeRTOS BLE Firmware
; Target: ESP32 (WROOM-32D) with BLE 5.3 + CAN Interface
; Framework: ESP-IDF 5.x with FreeRTOS

[platformio]
default_envs = cartelworx-esp32
src_dir = src
include_dir = include
lib_dir = lib

[env:cartelworx-esp32]
platform = espressif32 @ ^6.6.0
board = esp32dev
framework = espidf

; Build options
build_flags =
    -DCONFIG_BT_ENABLED=1
    -DCONFIG_BT_CTRL_BLE_MAX_ACTIVE=1
    -DCONFIG_BT_CTRL_MODE_EPC=1
    -DCONFIG_BT_CTRL_HCI_TL_EPC=1
    -DCONFIG_BT_NIMBLE_ENABLED=1
    -DCONFIG_BT_LE_LL_VENDOR_EXTENSION=1
    -DCONFIG_BT_LL_DYNAMIC_TX_BUF_NUM=1
    -DCONFIG_BT_LL_DYNAMIC_TX_BUF=1
    -DCONFIG_BT_RX_BUFFER_SIZE=256
    -DCONFIG_BT_TX_BUFFER_SIZE=512
    -DCONFIG_BT_NIMBLE_MAX_CONNECTIONS=1
    -DCONFIG_BT_NIMBLE_LOG_LEVEL=1
    ; FreeRTOS Configuration
    -DCONFIG_FREERTOS_TICK_RATE_HZ=1000
    -DCONFIG_FREERTOS_MAX_TASK_NAME_LEN=16
    -DCONFIG_FREERTOS_ENABLE_BACKWARD_COMPATIBILITY=1
    -DCONFIG_FREERTOS_TASK_FUNCTION_WRAPPER=1
    ; CAN/SPI Configuration
    -DCONFIG_CAN_GENERAL_CONFIG_BITRATE=500000
    ; Optimization for real-time knock detection
    -O2
    -Wall
    -Wno-format
    -Wno-parentheses
    -fstack-protector-strong
    -ffunction-sections
    -fdata-sections

monitor_speed = 115200
monitor_filters = 
    esp32_exception_decoder

upload_port = /dev/ttyUSB0
monitor_port = /dev/ttyUSB0

; Core 0 for real-time knock detection, Core 1 for BLE
board_build.partitions = partitions_custom.csv

; Library dependencies
lib_deps =
    ; Bluetooth LE
    https://github.com/espressif/esp-idf#release/v5.1
    ; SPI/CAN libraries
    
; Custom task for generating compiled firmware
custom_build_post =
    echo "Build completed successfully!"
    echo "Binary size analysis:"
    elf.bin size

[env:cartelworx-esp32-debug]
platform = espressif32 @ ^6.6.0
board = esp32dev
framework = espidf
build_flags =
    ${env:cartelworx-esp32.build_flags}
    -g
    -O0
    -DDEBUG_ENABLED=1
    -DCONFIG_LOG_DEFAULT_LEVEL_DEBUG=1

monitor_speed = 115200
monitor_filters = 
    esp32_exception_decoder

[env:cartelworx-esp32-test]
platform = espressif32 @ ^6.6.0
board = esp32dev
framework = espidf
build_flags =
    ${env:cartelworx-esp32.build_flags}
    -DUNIT_TEST=1
    -O0

test_framework = googletest
test_ignore = */functional/*

; Device capabilities
board_build.mcu = esp32
board_build.f_cpu = 240000000L
board_build.f_flash = 40000000L
board_build.flash_mode = dio
board_build.flash_size = 4MB
board_build.flash_freq = 40MHz
board_build.psram_size = 0

; Bootloader configuration
board_bootloader.version = 1.0
board_build.bootloader_addr = 0x1000
